<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>细说JavaScript作用域和闭包 | 金融前端组</title>
    <meta name="description" content="Department blog">
    <link rel="icon" href="/department-blog/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/department-blog/assets/css/0.styles.602ed1ae.css" as="style"><link rel="preload" href="/department-blog/assets/js/app.7eb48014.js" as="script"><link rel="preload" href="/department-blog/assets/js/4.a96d2e64.js" as="script"><link rel="preload" href="/department-blog/assets/js/1.feae924f.js" as="script"><link rel="preload" href="/department-blog/assets/js/18.2235ec60.js" as="script"><link rel="prefetch" href="/department-blog/assets/js/10.b8948ee3.js"><link rel="prefetch" href="/department-blog/assets/js/11.6a02a6a9.js"><link rel="prefetch" href="/department-blog/assets/js/12.e8bceccc.js"><link rel="prefetch" href="/department-blog/assets/js/13.35a28ba7.js"><link rel="prefetch" href="/department-blog/assets/js/14.438ac889.js"><link rel="prefetch" href="/department-blog/assets/js/15.db1cab85.js"><link rel="prefetch" href="/department-blog/assets/js/16.0005ff00.js"><link rel="prefetch" href="/department-blog/assets/js/17.9ca3bc60.js"><link rel="prefetch" href="/department-blog/assets/js/19.49784c99.js"><link rel="prefetch" href="/department-blog/assets/js/20.8f6e240e.js"><link rel="prefetch" href="/department-blog/assets/js/21.ece2a187.js"><link rel="prefetch" href="/department-blog/assets/js/22.4e3f4bae.js"><link rel="prefetch" href="/department-blog/assets/js/5.8e99c93d.js"><link rel="prefetch" href="/department-blog/assets/js/6.db6ffe20.js"><link rel="prefetch" href="/department-blog/assets/js/7.7f3e06f6.js"><link rel="prefetch" href="/department-blog/assets/js/8.d75f35de.js"><link rel="prefetch" href="/department-blog/assets/js/9.0ee677e5.js"><link rel="prefetch" href="/department-blog/assets/js/vendors~flowchart.d6ef213c.js">
    <link rel="stylesheet" href="/department-blog/assets/css/0.styles.602ed1ae.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/department-blog/" class="home-link router-link-active"><img src="/department-blog/head.png" alt="金融前端组" class="logo"> <span class="site-name">金融前端组</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><!----> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox" checked="checked"></div></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/department-blog/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/department-blog/category/前端.html" class="nav-link"><i class="iconfont undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/department-blog/category/随笔.html" class="nav-link"><i class="iconfont undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/department-blog/category/摘记.html" class="nav-link"><i class="iconfont undefined"></i>
  摘记
</a></li></ul></div></div><div class="nav-item"><a href="/department-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/department-blog/note/" class="nav-link"><i class="iconfont reco-document"></i>
  笔记
</a></div><div class="nav-item"><a href="/department-blog/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      关于我们
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/souche-finance-wireless/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://souche.yuque.com/bggh1p/front-end" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont /yuque.png"></i>
  语雀
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/souche-finance-wireless/department-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/department-blog/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/department-blog/category/前端.html" class="nav-link"><i class="iconfont undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/department-blog/category/随笔.html" class="nav-link"><i class="iconfont undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/department-blog/category/摘记.html" class="nav-link"><i class="iconfont undefined"></i>
  摘记
</a></li></ul></div></div><div class="nav-item"><a href="/department-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/department-blog/note/" class="nav-link"><i class="iconfont reco-document"></i>
  笔记
</a></div><div class="nav-item"><a href="/department-blog/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      关于我们
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/souche-finance-wireless/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://souche.yuque.com/bggh1p/front-end" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont /yuque.png"></i>
  语雀
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/souche-finance-wireless/department-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/department-blog/kaxpeo.html" class="sidebar-link">语雀站点搭建指南</a></li><li><a href="/department-blog/rwa4h7.html" class="sidebar-link">移动端H5的屏幕适配</a></li><li><a href="/department-blog/ouvmni.html" class="sidebar-link">项目中遇到的问题总结</a></li><li><section class="sidebar-group depth-0"><a href="/department-blog/gz116u.html" class="sidebar-heading clickable open"><span>JavaScript中的LHS查询和RHS查询</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/department-blog/al6n26.html" class="active sidebar-link">细说JavaScript作用域和闭包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/department-blog/al6n26.html#一、javascript有哪些作用域类型" class="sidebar-link">一、JavaScript有哪些作用域类型</a></li><li class="sidebar-sub-header"><a href="/department-blog/al6n26.html#二、作用域与标识符查询" class="sidebar-link">二、作用域与标识符查询</a></li><li class="sidebar-sub-header"><a href="/department-blog/al6n26.html#三、可以形成独立作用域的结构" class="sidebar-link">三、可以形成独立作用域的结构</a></li><li class="sidebar-sub-header"><a href="/department-blog/al6n26.html#四、提升" class="sidebar-link">四、提升</a></li><li class="sidebar-sub-header"><a href="/department-blog/al6n26.html#五、跨越词法作用域的两种机制" class="sidebar-link">五、跨越词法作用域的两种机制</a></li><li class="sidebar-sub-header"><a href="/department-blog/al6n26.html#六、闭包与模块机制" class="sidebar-link">六、闭包与模块机制</a></li></ul></li></ul></section></li></ul> </aside> <div><main class="page reco-hide"> <div class="page-title"><h1>细说JavaScript作用域和闭包</h1> <hr> <div data-v-362e684e><i class="iconfont reco-account" data-v-362e684e><span data-v-362e684e>金融前端组</span></i> <!----> <!----> <!----></div></div> <div class="content__default"><h1 id="细说javascript作用域和闭包"><a href="#细说javascript作用域和闭包" aria-hidden="true" class="header-anchor">#</a> 细说JavaScript作用域和闭包</h1> <p><span>作者：叶伟</span></p> <h2 id="一、javascript有哪些作用域类型"><a href="#一、javascript有哪些作用域类型" aria-hidden="true" class="header-anchor">#</a> 一、JavaScript有哪些作用域类型</h2> <p>对于一门编程语言来说，作用域主要有两种模型，即词法作用域（Lexical Scope）和动态作用域（Dynamic Scope）。而词法作用域,即静态作用域（Static Scope），被目前JavaScript在内的大部分编程语言所采用，而动态作用域只有Bash脚本等少数编程语言在使用。</p><p>词法作用域就是定义在词法阶段的作用域，当词法分析器处理代码的时候会保持作用域不变。在表现上，词法作用域的函数中遇到既不是形式参数也不是函数内部定义的局部变量的变量时，会自动去函数定义时的环境中查询（即沿作用域链）。</p><p>还是举两个例子吧：</p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table> <h2 id="二、作用域与标识符查询"><a href="#二、作用域与标识符查询" aria-hidden="true" class="header-anchor">#</a> 二、作用域与标识符查询</h2> <p>作用域和表示符查询紧密相关，表示符正是依靠这样一套严密的作用域规则而得以有条理地查询。而对于作用域，需要理解几个词：执行环境，变量对象，活动对象，作用域链。</p> <h3 id="执行环境与作用域链"><a href="#执行环境与作用域链" aria-hidden="true" class="header-anchor">#</a> 执行环境与作用域链</h3> <p>首先解释执行环境吧，执行环境定义了在这个执行环境中变量或者函数有权访问的数据，决定了它们各自的行为。在js中执行环境的结构由全局执行环境和一级级内部嵌套的子执行环境组成。其中全局执行环境由ECMAScript实现所在的宿主环境决定，在浏览器中为window对象，在Node中是global对象。每个函数都包含着自己的执行环境，一个个执行环境组成了一个执行环境栈，当执行流进入一个函数时，该函数的执行环境会被推入环境栈中，函数执行之后该环境又会被从环境栈中弹出，这便是ECMAScript执行流的机制。</p><p>每个执行环境都包含一个变量对象，它保存着环境中定义的所有变量和函数。当一个执行环境的代码执行的时候会为它的变量对象创建一个由当前执行环境沿着环境栈到全局执行环境的作用域链，作用域链保证了对当前执行环境有权访问的所有变量和函数的 <strong>有序</strong> 访问。如果当前执行环境是一个函数，那么该函数的活动对象就会成为这个执行环境的变量对象。</p><p>而对除了全局执行环境外的执行对象，活动对象最前端是arguments对象，而作用域链沿着一层层的被包含环境的变量对象沿伸到全局执行环境的变量对象。</p> <h3 id="标识符查询"><a href="#标识符查询" aria-hidden="true" class="header-anchor">#</a> 标识符查询</h3> <p>了解了执行环境和作用域链，标识符的查询就很好理解了，js引擎在遇到一个标识符的时候根据作用域链沿着变量对象从前端到后端进行查询（其实就是从子作用域逐层向父作用域查询），一旦遇到匹配的标识符便会<strong>立即停止</strong>。如：</p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table><p>该例中在console.log对a进行RHS查询时，在bar函数的作用域内便查询到了标识符a，因此便立即停止标识符查询，所以访问不到foo函数的标识符a。这种现象是标识符的遮蔽效应，在多层的嵌套作用域内可以定义同名的标识符，遮蔽效应使得内部的标识符可以遮蔽外层表示符。</p> <h2 id="三、可以形成独立作用域的结构"><a href="#三、可以形成独立作用域的结构" aria-hidden="true" class="header-anchor">#</a> 三、可以形成独立作用域的结构</h2> <p>在JavaScript中，可以形成独立作用域的结构有两类，函数作用域和块作用域。先说说函数作用域吧。</p> <h3 id="函数作用域"><a href="#函数作用域" aria-hidden="true" class="header-anchor">#</a> 函数作用域</h3> <p>函数作用域是js中最常见的作用域，每一个函数都拥有一个作用域，而属于这个函数的变量都能在整个函数的范围内访问（当然也能访问），但是在函数外则无法访问函数内的任何变量——除非你在函数执行时把一个闭包返回到函数体外。这种函数内部变量对外的隐藏作用使得同级作用域同名标识符之间的冲突得到避免，这样，也促成了模块机制的良好运行。</p> <h4 id="利用函数内部对外部的隐藏"><a href="#利用函数内部对外部的隐藏" aria-hidden="true" class="header-anchor">#</a> 利用函数内部对外部的隐藏</h4> <p>如果想创建一个封闭的作用域，让这个作用域内的变量不被外部访问，利用<strong>立即执行函数表达式</strong>（IIFE）便可实现。如：</p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table><p>这个函数表达式在声明后立即执行，这样函数体内的语句都得到了执行且对外部的变量没有影响。其实，JS中的模块也利用了这点。JS模块还是放到最后说吧。</p> <h4 id="匿名函数"><a href="#匿名函数" aria-hidden="true" class="header-anchor">#</a> 匿名函数</h4> <p>JavaScript中的函数表达式存在具名函数表达式和匿名函数表达式两种，而函数声明则必须具名。匿名函数有什么用呢？让我们不用去冥思苦想标识符怎么取。如上面的例子中的IIFE函数，该函数即使去掉函数名，程序也可以正常运行，因为它的函数名在这种情况起到作用不大。</p><p>虽然匿名函数写起来十分便捷，但是基于以下原因，始终给每个函数命名是值得推荐的。</p><ol><li>在没有函数名的情况下，函数的递归调用等需要引用自身的时候，将会不得不用<code>arguments.callee</code>进行引用，而这在ES5之后便不被推荐使用了——甚至在严格模式下会抛出TypeError错误。</li><li>函数名的省略使得代码可读性下降</li></ol><p>说到了匿名函数，不得不提闭包，由于闭包内容较多，将在后面专门说明。</p> <h3 id="块作用域"><a href="#块作用域" aria-hidden="true" class="header-anchor">#</a> 块作用域</h3> <p>除了最常见的函数作用域，JavaScript中的块作用域也可以创建出一个独立的作用域。可是，在 Nicholas C.Zakas 著的《Professional JavaScript for Web Developers(3rd Edition)》中说道：</p><blockquote style="padding-left:1em;"><h4 id="no-block-level-scopes"><a href="#no-block-level-scopes" aria-hidden="true" class="header-anchor">#</a> No Block-Level Scopes</h4> <p>JavaScript’s lack of block-level scopes is a common source of confusion. In other C-like languages, code blocks enclosed by brackets have their own scope (more accurately described as their own execution context in ECMAScript), allowing conditional definition of variables.</p></blockquote><p>Nicholas 之所以说JavaScript没有块级作用域是因为他没把<code>with</code>和<code>try/catch</code>作为块级作用域看待，他在书中把这两个情况作为延长作用域链的手段。实际上，通过<code>with</code>和<code>try/catch</code>创建的独立作用域也算是块级作用域的形式，除了这两种外还可以利用ES6中的<code>let</code>和<code>const</code>也可以形成块级作用域。</p> <h4 id="with"><a href="#with" aria-hidden="true" class="header-anchor">#</a> with</h4> <p>通过with可以创建出的作用域仅在with声明中使用。如：</p><table class="lake-table"><colgroup><col width="40"><col width="472"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table> <h4 id="try-catch"><a href="#try-catch" aria-hidden="true" class="header-anchor">#</a> try/catch</h4> <p><code>try/catch</code>的catch分句会创建一个块级作用域，其中声明的变量只能在内部使用。如：</p><table class="lake-table"><colgroup><col width="40"><col width="562"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table> <h4 id="let-const"><a href="#let-const" aria-hidden="true" class="header-anchor">#</a> let/const</h4> <p>ES6中引入的let和const关键字可以将变量绑定到任意由{}包含的代码块中。</p><p>以下例子可以看出用let声明变量和用var声明变量的区别：</p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table><p>当然，也可以直接绑定在块中，如：</p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table><p>const关键字定义的常量和let一样，能将其定义的常量绑定到{}包含的块级作用域中，就再举例子了。</p> <h2 id="四、提升"><a href="#四、提升" aria-hidden="true" class="header-anchor">#</a> 四、提升</h2> <p>提升的概念比较简单，但是如果对js语言只是浅尝辄止的话，可能会理解不清。这里通过提升的表现，优先级和原因来简单说明js中的提升。</p> <h3 id="提升的表现"><a href="#提升的表现" aria-hidden="true" class="header-anchor">#</a> 提升的表现</h3> <p>提升是变量或函数在同个作用域内表现出的可以先使用后定义的现象。先来看看变量提升：</p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table><p>再看看函数提升：</p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table> <h3 id="提升的优先级"><a href="#提升的优先级" aria-hidden="true" class="header-anchor">#</a> 提升的优先级</h3> <p>提升具有优先级，当一个作用域里对同个标识符既使用了变量声明，也使用了函数声明，那么函数声明会优先被提升。如下面的例子。</p><p><a target="_blank"></a></p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table> <h3 id="提升的深层原因"><a href="#提升的深层原因" aria-hidden="true" class="header-anchor">#</a> 提升的深层原因</h3> <p>提升之所以存在，是因为JavaScript引擎在对代码解释前会进行预编译。在编译阶段，有一部分的工作就是找到所有的函数声明，并用合适的作用域把它们关联起来，这也是词法作用域的核心部分。有了预编译，在解释执行时，不再检测变量的声明，引擎在对变量进行LHS或RHS查询时会直接向编译阶段生成的作用域取得数据。</p><p>也就是说对于<code>var a = 1’;</code>这个语句来说，js引擎会识别为两个声明，即<code>var a</code> 和<code>a = 1</code>，他们分别在编译阶段和执行阶段处理。</p> <h2 id="五、跨越词法作用域的两种机制"><a href="#五、跨越词法作用域的两种机制" aria-hidden="true" class="header-anchor">#</a> 五、跨越词法作用域的两种机制</h2> <p>虽然JavaScript采用的是词法作用域，但是如果真的想要在代码执行的时候修改作用域的话也是有办法的，因为js中存在两个”bug”来做到这点。这两个”bug”是传说中的<code>eval</code>还有之前提到过的<code>with</code>。由于这两个”bug”，js的作用域应该算是不完全的词法作用域。</p> <h3 id="eval"><a href="#eval" aria-hidden="true" class="header-anchor">#</a> eval</h3> <p>eval可能是js中最强大的函数了，它接受一个参数即一个字符串，在执行时会把这个字符串作为实际的ECMA语句插入到原位置进行解析执行，正如下面例子所示。</p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table><p>因为在js编译器预编译的时候，eval()中的语句并不会被执行，所以，eval()中的变量或者函数不会被提升。</p><table class="lake-table"><colgroup><col width="40"><col width="578"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table><p>当然，如果变量/函数的定义和使用都在eval中，那么里面的变量对于里面的调用来说是有提升的，比如:</p><table class="lake-table"><colgroup><col width="40"><col width="463"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr><tr><td colspan="1" style="text-align:left;background-color:#FFFFFF;"></td><td colspan="1" style="text-align:left;background-color:#FFFFFF;"></td></tr></tbody></table><p>JavaScript中还有一些类似<code>eval()</code>处理方式的函数，比如<code>new Function(..)</code>，<code>setInterval(..)</code>和<code>setTimeout(..)</code>等等。</p> <h3 id="with-2"><a href="#with-2" aria-hidden="true" class="header-anchor">#</a> with</h3> <p>with语句同样可以在执行阶段修改作用域。</p><p>如</p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table><p>在with语句的代码块里面，a,b,c来自obj的三个属性，这个在js预编译的时候也是不能判断的，因此with语句中的变量也不能在词法阶段确定。</p> <h2 id="六、闭包与模块机制"><a href="#六、闭包与模块机制" aria-hidden="true" class="header-anchor">#</a> 六、闭包与模块机制</h2> <h3 id="闭包"><a href="#闭包" aria-hidden="true" class="header-anchor">#</a> 闭包</h3> <p>说起闭包，在我刚接触JavaScript的时候听到这个词的时候感觉它特别神秘——从这个奇怪的名字就感觉到了神秘感。直到深入了解后才发现，闭包，原来是这样。</p> <h4 id="什么是闭包"><a href="#什么是闭包" aria-hidden="true" class="header-anchor">#</a> 什么是闭包</h4> <p>当一个函数能够保存自己所在的词法作用域的时，便产生了闭包——无论这个是在当前词法作用域中还是当前词法作用域外。</p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table><p>在上面的例子中，在调用foo函数时bar函数保存着foo函数的局部变量a，在bar函数被返回到foo函数外面的时候，便产生了闭包，闭包里保存着bar所在的词法作用域（包含bar函数和foo函数的所有变量以及全局对象的所有属性），故调用baz函数的时候能够正常返回a中的值2。</p> <h4 id="闭包相关的问题"><a href="#闭包相关的问题" aria-hidden="true" class="header-anchor">#</a> 闭包相关的问题</h4> <h5 id="问题"><a href="#问题" aria-hidden="true" class="header-anchor">#</a> 问题</h5> <p>首先看下面的例子:</p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table><p>这个例子中可以看出这段代码预期是按顺序分别输出1～5的数字。而实际上，每次都输出6。</p><p>现仔细造成这个”出乎意料“的现象的原因：setTimeout函数中传进来的timer函数由于作用域闭包的原因，保存着对<strong>同一个</strong>变量 i 的引用，而在循环结束后i的值为6，又由于js的异步性，在过1000ms之后，循环已经处理结束，因此，结果会输出5个6。</p> <h5 id="解决办法"><a href="#解决办法" aria-hidden="true" class="header-anchor">#</a> 解决办法</h5> <p>只需对上面代码进行一些改进即可解决，代码如下：</p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table><p>上面代码通过创建一个自执行的函数表达式来得到一个独立的作用域，再把外部的i作为参数传进函数体，因为函数的参数传递会创建一个副本，所以每个timer中保存不同的i的副本，问题就得到解决了。</p> <h3 id="模块机制"><a href="#模块机制" aria-hidden="true" class="header-anchor">#</a> 模块机制</h3> <p>JavaScript中的模块模式正是充分利用了作用域闭包的能力而实现的。下面由简入深地描述js中的模块机制。</p> <h4 id="简单的模块"><a href="#简单的模块" aria-hidden="true" class="header-anchor">#</a> 简单的模块</h4> <p>有了闭包的知识的话，下面的模块代码相信能很快看懂。</p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table> <h4 id="单例模式"><a href="#单例模式" aria-hidden="true" class="header-anchor">#</a> 单例模式</h4> <p>将上面代码改变一下，可以实现单例模式：</p><table class="lake-table"><colgroup><col width="40"><col width="360"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table> <h4 id="现代模块机制"><a href="#现代模块机制" aria-hidden="true" class="header-anchor">#</a> 现代模块机制</h4> <p>现在实现的模块通常需要一个模块管理器，其一般实现如下：</p><table class="lake-table"><colgroup><col width="40"><col width="666"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table><p>这个模块管理器的实现中，<code>deps[i] = modules[deps[i]];</code>语句根据目标定义模块所需要的依赖从modules中查询，而<code>modules[name] = impl.apply(impl, deps);</code>语句则将目标依赖注入到定义模块中。</p><p>通过上面的模块管理器，可以轻松创建模块，管理模块之间的依赖。</p><table class="lake-table"><colgroup><col width="40"><col width="605"></colgroup><tbody><tr><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td><td style="text-align:left;"><div class="language-undefined line-numbers-mode"><pre class="language-text"><code> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></td></tr></tbody></table><p style="text-align:left;"><br></p></div> <!----> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/department-blog/ouvmni.html" class="prev">
          项目中遇到的问题总结
        </a></span> <!----></p></div> </main> <div class="valine-wrapper" data-v-5029e45b><div id="valine" data-v-5029e45b></div></div></div> <div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-cd623d78 data-v-cd623d78><i class="iconfont reco-up" data-v-cd623d78></i></div></div></div></div><div class="global-ui"></div></div>
    <script src="/department-blog/assets/js/app.7eb48014.js" defer></script><script src="/department-blog/assets/js/4.a96d2e64.js" defer></script><script src="/department-blog/assets/js/1.feae924f.js" defer></script><script src="/department-blog/assets/js/18.2235ec60.js" defer></script>
  </body>
</html>
